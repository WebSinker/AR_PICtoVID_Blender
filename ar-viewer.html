<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>AR Experience Viewer</title>
  
  <!-- AR.js with Image Tracking (NFT) -->
  <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c2407b26c61958baa93967b5412487cd94b290b/dist/aframe-master.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      position: fixed;
      width: 100%;
      height: 100%;
      touch-action: none;
    }

    /* Loading Screen - Mobile Optimized */
    .arjs-loader {
      height: 100%;
      width: 100%;
      position: fixed;
      top: 0;
      left: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 20px;
    }

    .arjs-loader div {
      text-align: center;
      color: white;
      padding: 15px;
      max-width: 90%;
    }

    .arjs-loader h2 {
      font-size: 1.5em;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .arjs-loader p {
      font-size: 1em;
      margin: 8px 0;
      opacity: 0.95;
      line-height: 1.5;
    }

    .spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Mobile Instructions - Large and Clear */
    .instructions {
      position: fixed;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(76, 175, 80, 0.95);
      color: white;
      padding: 18px 25px;
      border-radius: 30px;
      z-index: 1000;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      max-width: 85%;
      animation: pulse 2s infinite;
      line-height: 1.4;
    }

    @keyframes pulse {
      0%, 100% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.03); }
    }

    .instructions.hidden {
      display: none;
    }

    /* Found Message - Bigger for Mobile */
    .found-message {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(76, 175, 80, 0.98);
      color: white;
      padding: 25px 35px;
      border-radius: 25px;
      z-index: 999;
      font-size: 20px;
      font-weight: bold;
      display: none;
      box-shadow: 0 6px 25px rgba(0,0,0,0.4);
      animation: slideUp 0.5s ease;
      max-width: 85%;
      text-align: center;
    }

    .found-message.show {
      display: block;
    }

    @keyframes slideUp {
      from {
        transform: translateX(-50%) translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    /* Error Message - Mobile Friendly */
    .error-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(244, 67, 54, 0.98);
      color: white;
      padding: 30px 25px;
      border-radius: 20px;
      z-index: 10000;
      text-align: center;
      display: none;
      max-width: 85%;
      box-shadow: 0 6px 30px rgba(0,0,0,0.5);
    }

    .error-message.show {
      display: block;
    }

    .error-message h3 {
      font-size: 1.3em;
      margin-bottom: 15px;
    }

    .error-message p {
      font-size: 1em;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    .error-message button {
      background: white;
      color: #f44336;
      border: none;
      padding: 15px 30px;
      border-radius: 25px;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      touch-action: manipulation;
    }

    /* Help Button - Touch Optimized */
    .help-button {
      position: fixed;
      bottom: 25px;
      right: 25px;
      background: rgba(33, 150, 243, 0.95);
      color: white;
      border: none;
      padding: 18px;
      border-radius: 50%;
      font-size: 26px;
      cursor: pointer;
      z-index: 998;
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
      touch-action: manipulation;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .help-button:active {
      transform: scale(0.95);
    }

    /* Help Panel - Mobile Optimized */
    .help-panel {
      position: fixed;
      bottom: 95px;
      right: 20px;
      background: rgba(255, 255, 255, 0.98);
      padding: 20px;
      border-radius: 20px;
      z-index: 997;
      max-width: calc(100% - 40px);
      width: 300px;
      box-shadow: 0 6px 30px rgba(0,0,0,0.4);
      display: none;
    }

    .help-panel.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .help-panel h3 {
      color: #667eea;
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.2em;
    }

    .help-panel ul {
      margin: 0;
      padding-left: 20px;
      line-height: 1.8;
      color: #333;
      font-size: 14px;
    }

    .help-panel li {
      margin-bottom: 8px;
    }

    @keyframes fadeIn {
      from { 
        opacity: 0; 
        transform: translateY(10px) scale(0.95); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
      }
    }

    /* Status Indicator */
    .status-bar {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      z-index: 996;
      font-size: 13px;
      display: none;
      max-width: 85%;
      text-align: center;
    }

    .status-bar.show {
      display: block;
    }

    /* Camera Controls Overlay */
    .camera-controls {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      z-index: 995;
      display: none;
    }

    .camera-controls.show {
      display: flex;
    }

    .control-btn {
      background: rgba(255, 255, 255, 0.9);
      border: none;
      padding: 15px 25px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: bold;
      color: #667eea;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      touch-action: manipulation;
    }

    .control-btn:active {
      transform: scale(0.95);
    }

    /* Marker Detection Indicator */
    .detection-ring {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 250px;
      height: 250px;
      border: 3px dashed rgba(76, 175, 80, 0.6);
      border-radius: 20px;
      z-index: 994;
      display: none;
      animation: scan 2s linear infinite;
      pointer-events: none;
    }

    .detection-ring.show {
      display: block;
    }

    @keyframes scan {
      0%, 100% { 
        border-color: rgba(76, 175, 80, 0.6);
        transform: translate(-50%, -50%) scale(1);
      }
      50% { 
        border-color: rgba(76, 175, 80, 1);
        transform: translate(-50%, -50%) scale(1.05);
      }
    }

    /* Print Marker Button */
    .print-marker-btn {
      position: fixed;
      bottom: 25px;
      left: 25px;
      background: rgba(156, 39, 176, 0.95);
      color: white;
      border: none;
      padding: 15px 20px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      z-index: 998;
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
      touch-action: manipulation;
    }

    .print-marker-btn:active {
      transform: scale(0.95);
    }

    /* Responsive adjustments */
    @media (max-width: 400px) {
      .instructions {
        font-size: 14px;
        padding: 15px 20px;
      }

      .found-message {
        font-size: 18px;
        padding: 20px 25px;
      }

      .help-button {
        width: 55px;
        height: 55px;
        font-size: 24px;
      }

      .print-marker-btn {
        font-size: 12px;
        padding: 12px 16px;
      }
    }

    /* Landscape mode adjustments */
    @media (orientation: landscape) and (max-height: 500px) {
      .instructions {
        top: 10px;
        font-size: 13px;
        padding: 12px 20px;
      }

      .help-button, .print-marker-btn {
        bottom: 15px;
      }

      .help-panel {
        bottom: 75px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="arjs-loader">
    <div>
      <h2>üé¨ Loading AR Experience</h2>
      <div class="spinner"></div>
      <p>üì∏ Please allow camera access when prompted</p>
      <p>üîç Preparing image tracker...</p>
      <p style="font-size: 0.85em; opacity: 0.8; margin-top: 15px;">üí° Tip: Ensure good lighting for best results</p>
    </div>
  </div>

  <!-- Instructions -->
  <div class="instructions" id="instructions">
    üì∏ Point camera at HIRO marker!<br>
    <small style="font-size: 0.85em; opacity: 0.9;">Hold steady & keep marker visible</small>
  </div>

  <!-- Status Bar -->
  <div class="status-bar" id="statusBar">
    üîç Searching for marker...
  </div>

  <!-- Detection Ring -->
  <div class="detection-ring" id="detectionRing"></div>

  <!-- Found Message -->
  <div class="found-message" id="foundMessage">
    ‚ú® Marker Found!<br>
    <small style="font-size: 0.8em;">Enjoy your AR video! üé¨</small>
  </div>

  <!-- Error Message -->
  <div class="error-message" id="errorMessage">
    <h3>‚ö†Ô∏è Camera Access Required</h3>
    <p>This AR experience needs camera access to work. Please allow camera permissions in your browser settings.</p>
    <button onclick="location.reload()">üîÑ Try Again</button>
  </div>

  <!-- Help Button -->
  <button class="help-button" onclick="toggleHelp()" aria-label="Help">‚ùì</button>
  
  <!-- Print Marker Button -->
  <button class="print-marker-btn" onclick="showMarkerInfo()">üìÑ Get Marker</button>

  <!-- Help Panel -->
  <div class="help-panel" id="helpPanel">
    <h3>üí° Tips for Success</h3>
    <ul>
      <li><strong>Lighting:</strong> Use good lighting, avoid shadows</li>
      <li><strong>Distance:</strong> Hold marker 30-50cm from camera</li>
      <li><strong>Stability:</strong> Keep marker flat and steady</li>
      <li><strong>Visibility:</strong> Show entire marker on screen</li>
      <li><strong>Glare:</strong> Avoid reflections on marker</li>
    </ul>
  </div>

  <!-- AR Scene -->
  <a-scene
    vr-mode-ui="enabled: false;"
    renderer="logarithmicDepthBuffer: true; precision: medium; antialias: true;"
    embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960;">
    
    <!-- Using HIRO marker for demo -->
    <a-marker preset="hiro" id="markerDetected" emitevents="true" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
      
      <!-- White border frame around video (BEHIND the video) -->
      <a-plane
        position="0 0 -0.01"
        rotation="-90 0 0"
        width="1.8"
        height="1.8"
        color="#ffffff"
        opacity="1">
      </a-plane>
      
      <!-- Video Plane - Fixed directly on marker surface -->
      <a-video
        id="arVideo"
        src="#demoVideo"
        width="1.6"
        height="1.6"
        position="0 0 0"
        rotation="-90 0 0"
        play="false"
        opacity="1">
      </a-video>
      
      <!-- Play Icon overlay (shows when video paused) -->
      <a-circle
        id="playIcon"
        position="0 0 0.01"
        rotation="-90 0 0"
        radius="0.25"
        color="#4caf50"
        opacity="0.9"
        visible="false">
        <a-cone
          position="0.05 0 0.01"
          rotation="0 0 90"
          radius-bottom="0.15"
          radius-top="0"
          height="0.2"
          color="#ffffff">
        </a-cone>
      </a-circle>
      
    </a-marker>

    <!-- Camera -->
    <a-entity camera look-controls="enabled: false"></a-entity>
  </a-scene>

  <!-- Assets -->
  <a-assets>
    <video
      id="demoVideo"
      crossorigin="anonymous"
      loop
      preload="auto"
      playsinline
      webkit-playsinline
      style="display: none;">
      <source src="https://cdn.aframe.io/examples/assets/videos/bunny.mp4" type="video/mp4">
    </video>
  </a-assets>

  <script>
    let helpVisible = false;
    let videoPlaying = false;
    let markerVisible = false;

    // Prevent default touch behaviors
    document.addEventListener('touchmove', function(e) {
      if (e.scale !== 1) { e.preventDefault(); }
    }, { passive: false });

    // Toggle help panel
    function toggleHelp() {
      helpVisible = !helpVisible;
      const panel = document.getElementById('helpPanel');
      panel.classList.toggle('show', helpVisible);
    }

    // Show marker info
    function showMarkerInfo() {
      alert('üìã To use this AR experience:\n\n1. Print the HIRO marker (Google "HIRO AR marker")\n2. Or display it on another device screen\n3. Point your camera at the marker\n4. Keep the marker flat and visible\n5. Enjoy your AR video!\n\nüí° Tip: The marker is a black square with a pattern inside.');
    }

    // Mobile-optimized video controls
    function playVideo() {
      const video = document.querySelector('#demoVideo');
      if (video && !videoPlaying) {
        // Force play for mobile
        const playPromise = video.play();
        if (playPromise !== undefined) {
          playPromise
            .then(() => {
              console.log('Video playing successfully');
              videoPlaying = true;
              document.getElementById('playIcon').setAttribute('visible', 'false');
            })
            .catch(error => {
              console.log('Play prevented:', error);
              // Try again with user interaction
              setTimeout(() => {
                video.play().catch(e => console.log('Retry failed:', e));
              }, 100);
            });
        }
      }
    }

    function pauseVideo() {
      const video = document.querySelector('#demoVideo');
      if (video) {
        video.pause();
        videoPlaying = false;
        document.getElementById('playIcon').setAttribute('visible', 'true');
      }
    }

    // Wait for AR.js to load
    window.addEventListener('load', function() {
      console.log('AR Experience loaded');
      
      // Hide loader when AR is ready
      setTimeout(() => {
        const loader = document.querySelector('.arjs-loader');
        loader.style.display = 'none';
        
        // Show detection ring
        document.getElementById('detectionRing').classList.add('show');
        document.getElementById('statusBar').classList.add('show');
      }, 3000);

      // Set up video for mobile
      const video = document.querySelector('#demoVideo');
      if (video) {
        video.setAttribute('playsinline', '');
        video.setAttribute('webkit-playsinline', '');
        video.muted = false; // Enable sound
      }
    });

    // Marker detection events
    const marker = document.querySelector('#markerDetected');
    const foundMessage = document.getElementById('foundMessage');
    const instructions = document.getElementById('instructions');
    const statusBar = document.getElementById('statusBar');
    const detectionRing = document.getElementById('detectionRing');

    marker.addEventListener('markerFound', function() {
      console.log('‚úÖ Marker detected!');
      markerVisible = true;
      
      // Update UI
      instructions.classList.add('hidden');
      foundMessage.classList.add('show');
      statusBar.textContent = '‚úÖ Marker detected!';
      detectionRing.classList.remove('show');
      
      // Play video
      playVideo();
      
      // Hide found message after 2 seconds
      setTimeout(() => {
        foundMessage.classList.remove('show');
        statusBar.classList.remove('show');
      }, 2000);
    });

    marker.addEventListener('markerLost', function() {
      console.log('‚ùå Marker lost');
      markerVisible = false;
      
      // Update UI
      instructions.classList.remove('hidden');
      statusBar.textContent = 'üîç Searching for marker...';
      statusBar.classList.add('show');
      detectionRing.classList.add('show');
      
      // Pause video
      pauseVideo();
    });

    // Handle camera permissions
    navigator.mediaDevices.getUserMedia({ 
      video: { 
        facingMode: 'environment',
        width: { ideal: 1280 },
        height: { ideal: 960 }
      } 
    })
      .then(function(stream) {
        console.log('‚úÖ Camera access granted');
        stream.getTracks().forEach(track => track.stop());
      })
      .catch(function(error) {
        console.error('‚ùå Camera access denied:', error);
        document.querySelector('.arjs-loader').style.display = 'none';
        document.getElementById('errorMessage').classList.add('show');
      });

    // Auto-hide instructions with fade
    setTimeout(() => {
      if (!markerVisible && !instructions.classList.contains('hidden')) {
        instructions.style.opacity = '0.8';
      }
    }, 10000);

    // Get experience ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const experienceId = urlParams.get('id');
    
    if (experienceId) {
      console.log('üì± Loading AR experience:', experienceId);
      // In production, fetch the actual video URL based on experienceId
    }

    // Vibration feedback on marker found (if supported)
    if ('vibrate' in navigator) {
      marker.addEventListener('markerFound', () => {
        navigator.vibrate(100);
      });
    }
  </script>
</body>
</html>
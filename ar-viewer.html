<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>AR Video Experience</title>
  
  <!-- AR.js with stable versions -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.3.0/dist/aframe-master.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    }

    .arjs-loader {
      height: 100vh;
      width: 100vw;
      position: fixed;
      top: 0;
      left: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
      text-align: center;
      padding: 20px;
    }

    .arjs-loader h2 {
      font-size: 1.8em;
      margin-bottom: 20px;
    }

    .arjs-loader p {
      font-size: 1.1em;
      margin: 10px 0;
      opacity: 0.9;
    }

    .spinner {
      border: 5px solid rgba(255,255,255,0.3);
      border-top: 5px solid white;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .instructions {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(76, 175, 80, 0.95);
      color: white;
      padding: 20px 30px;
      border-radius: 30px;
      z-index: 1000;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      max-width: 90%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.05); }
    }

    .marker-found {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(76, 175, 80, 0.95);
      color: white;
      padding: 25px 40px;
      border-radius: 25px;
      z-index: 999;
      font-size: 22px;
      font-weight: bold;
      display: none;
      box-shadow: 0 6px 25px rgba(0,0,0,0.4);
      animation: slideUp 0.5s ease;
    }

    .marker-found.show {
      display: block;
    }

    @keyframes slideUp {
      from {
        transform: translateX(-50%) translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    .help-button {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: rgba(33, 150, 243, 0.95);
      color: white;
      border: none;
      padding: 20px;
      border-radius: 50%;
      font-size: 28px;
      cursor: pointer;
      z-index: 998;
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
      width: 70px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Enable interaction overlay for video */
    .video-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1001;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
    }

    .video-overlay.hidden {
      display: none;
    }

    .video-overlay button {
      background: #4caf50;
      color: white;
      border: none;
      padding: 20px 40px;
      font-size: 20px;
      border-radius: 30px;
      cursor: pointer;
      margin-top: 20px;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .video-overlay h2 {
      margin-bottom: 10px;
      font-size: 2em;
    }

    .video-overlay p {
      font-size: 1.2em;
      opacity: 0.9;
      text-align: center;
      max-width: 80%;
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="arjs-loader">
    <h2>üé¨ Loading AR Experience...</h2>
    <div class="spinner"></div>
    <p>Please allow camera access</p>
    <p>Point your camera at the HIRO marker</p>
  </div>

  <!-- Video Enable Overlay -->
  <div class="video-overlay" id="videoOverlay">
    <h2>üì± Tap to Start AR</h2>
    <p>Click the button below to enable video and audio for the AR experience</p>
    <button onclick="enableVideo()">üé• Enable Video</button>
  </div>

  <!-- Instructions -->
  <div class="instructions" id="instructions">
    üì∏ Point camera at HIRO marker!<br>
    <span style="font-size: 0.85em;">Hold steady & keep marker visible</span>
  </div>

  <!-- Marker Found Message -->
  <div class="marker-found" id="markerFound">
    ‚úÖ Marker Detected!
  </div>

  <!-- Help Button -->
  <button class="help-button" onclick="showMarkerInfo()">?</button>

  <!-- AR Scene -->
  <a-scene
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; trackingMethod: best;"
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true; precision: medium;"
    loading-screen="enabled: false">

    <!-- Assets INSIDE a-scene -->
    <a-assets>
      <video
        id="arVideo"
        crossorigin="anonymous"
        loop
        preload="auto"
        playsinline
        webkit-playsinline
        style="display: none;">
        <!-- Replace with your own video URL -->
        <source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">
      </video>
    </a-assets>

    <!-- HIRO Marker with Video -->
    <a-marker id="hiroMarker" preset="hiro" smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
      
      <!-- White background plane -->
      <a-plane
        position="0 0 0"
        rotation="-90 0 0"
        width="2"
        height="2"
        color="#ffffff"
        opacity="1">
      </a-plane>
      
      <!-- Video Plane -->
      <a-video
        id="videoPlane"
        src="#arVideo"
        width="1.8"
        height="1.8"
        position="0 0 0.01"
        rotation="-90 0 0">
      </a-video>
      
    </a-marker>

    <!-- Camera -->
    <a-entity camera look-controls="enabled: false"></a-entity>
  </a-scene>

  <script>
    let videoEnabled = false;
    let markerVisible = false;
    let video = null;

    // Wait for scene to load
    document.addEventListener('DOMContentLoaded', function() {
      const scene = document.querySelector('a-scene');
      
      // Hide loader when scene is ready
      if (scene.hasLoaded) {
        init();
      } else {
        scene.addEventListener('loaded', init);
      }
    });

    function init() {
      console.log('AR scene loaded');
      
      // Hide loader
      setTimeout(() => {
        document.querySelector('.arjs-loader').style.display = 'none';
      }, 1500);

      video = document.getElementById('arVideo');
      
      // Set video properties for mobile
      video.setAttribute('playsinline', '');
      video.setAttribute('webkit-playsinline', '');
      video.muted = true; // Start muted for autoplay
      
      // Setup marker events
      setupMarkerEvents();
    }

    function enableVideo() {
      console.log('User enabled video');
      videoEnabled = true;
      document.getElementById('videoOverlay').classList.add('hidden');
      
      // Initialize video
      if (video) {
        video.muted = false; // Try to unmute
        video.load();
        
        // Try initial play-pause cycle to initialize
        video.play().then(() => {
          video.pause();
          video.currentTime = 0;
          console.log('Video initialized');
        }).catch(e => {
          console.log('Initial play failed, will try muted:', e);
          video.muted = true;
        });
      }
    }

    function setupMarkerEvents() {
      const marker = document.querySelector('#hiroMarker');
      const instructions = document.getElementById('instructions');
      const markerFound = document.getElementById('markerFound');

      marker.addEventListener('markerFound', function() {
        console.log('‚úÖ HIRO Marker detected!');
        markerVisible = true;
        
        // Update UI
        instructions.style.display = 'none';
        markerFound.classList.add('show');
        
        // Auto-hide message after 2 seconds
        setTimeout(() => {
          markerFound.classList.remove('show');
        }, 2000);
        
        // Play video
        playVideo();
        
        // Vibration feedback if supported
        if ('vibrate' in navigator) {
          navigator.vibrate(100);
        }
      });

      marker.addEventListener('markerLost', function() {
        console.log('‚ùå Marker lost');
        markerVisible = false;
        
        // Update UI
        instructions.style.display = 'block';
        
        // Pause video
        pauseVideo();
      });
    }

    function playVideo() {
      if (!video) return;
      
      console.log('Attempting to play video...');
      
      // Try unmuted first
      video.muted = false;
      
      const playPromise = video.play();
      
      if (playPromise !== undefined) {
        playPromise
          .then(() => {
            console.log('‚úÖ Video playing with sound');
          })
          .catch(error => {
            console.log('‚ö†Ô∏è Unmuted play failed, trying muted:', error);
            // Fallback to muted
            video.muted = true;
            video.play()
              .then(() => {
                console.log('‚úÖ Video playing (muted)');
                // Try to unmute after a short delay
                setTimeout(() => {
                  video.muted = false;
                }, 1000);
              })
              .catch(e => {
                console.error('‚ùå Video play failed completely:', e);
              });
          });
      }
    }

    function pauseVideo() {
      if (video && !video.paused) {
        video.pause();
        console.log('‚è∏Ô∏è Video paused');
      }
    }

    function showMarkerInfo() {
      alert('üìã How to use:\n\n1. Get the HIRO marker:\n   ‚Ä¢ Google "HIRO AR marker"\n   ‚Ä¢ Or get it at: https://github.com/AR-js-org/AR.js/blob/master/data/images/hiro.png\n\n2. Print or display the marker on another screen\n\n3. Point your camera at the marker\n\n4. Keep the marker flat and fully visible\n\n5. The video will appear and play on the marker!\n\nüí° Tip: Good lighting helps detection!');
    }

    // Handle camera permission errors
    navigator.mediaDevices.getUserMedia({ 
      video: { 
        facingMode: 'environment',
        width: { ideal: 1280 },
        height: { ideal: 720 }
      } 
    })
    .then(function(stream) {
      console.log('‚úÖ Camera access granted');
      stream.getTracks().forEach(track => track.stop());
    })
    .catch(function(error) {
      console.error('‚ùå Camera access denied:', error);
      alert('‚ö†Ô∏è Camera access is required for AR.\n\nPlease:\n1. Allow camera access in your browser settings\n2. Refresh the page\n3. Grant camera permission when prompted');
    });
  </script>
</body>
</html>